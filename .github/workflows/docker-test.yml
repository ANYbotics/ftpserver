name: Docker test

on:
  schedule:
    # We want to run it every day
    - cron:  '*/5 * * * *'

jobs:
  test-docker-image:
    runs-on: ubuntu-latest
    timeout-minutes: 1
    services:
      ftpserver:
        image: ftpserver/ftpserver
        ports:
          - 2121:2121

    steps:
      - name: Run sample
        env:
          SERVER_PORT: 2121
        run: |
          set -xe
          whoami
          sudo apt-get update
          sudo apt-get install curl -y

          # Getting a file
          curl -o file.bin https://github.com/fclairamb/ftpserver/releases/download/v0.5/ftpserver-linux-amd64

          # Waiting for server to be reading
          while ! nc -z localhost ${SERVER_PORT} </dev/null; do sleep 1; done

          # Upload a file
          curl -T file.bin ftp://test:test@localhost:2121/remote.bin

          # Download a file
          curl ftp://test:test@localhost:2121/remote.bin -o remote.bin

          # Checking that the output file exists
          if [ ! -f remote.bin ]; then
            exit 1
          fi

          # Comparing file contents
          diff file.bin remote.bin

